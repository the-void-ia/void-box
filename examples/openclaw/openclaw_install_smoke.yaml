api_version: v1
kind: workflow
name: openclaw-install-smoke

sandbox:
  mode: auto
  memory_mb: 2048
  vcpus: 2
  network: true
  image: "node:22"

workflow:
  steps:
    - name: env_probe
      run:
        program: sh
        args:
          - -lc
          - |
            set -eux
            cat /etc/os-release || true
            node --version
            npm --version
            command -v sh
            touch /tmp/voidbox-rw-check
            rm -f /tmp/voidbox-rw-check
            (touch /usr/local/voidbox-ro-check && rm -f /usr/local/voidbox-ro-check) || true

    - name: install_openclaw
      depends_on: [env_probe]
      run:
        program: sh
        args:
          - -lc
          - |
            set -eux
            export NPM_CONFIG_REGISTRY="https://registry.npmjs.org/"
            export NPM_CONFIG_FETCH_RETRIES=3
            export NPM_CONFIG_FETCH_RETRY_FACTOR=2
            export NPM_CONFIG_FETCH_RETRY_MINTIMEOUT=1000
            export NPM_CONFIG_FETCH_RETRY_MAXTIMEOUT=15000
            export NPM_CONFIG_FETCH_TIMEOUT=90000
            export NPM_CONFIG_NETWORK_TIMEOUT=90000
            export NPM_CONFIG_CACHE="/tmp/.npm"
            export OPENCLAW_PREFIX="/tmp/openclaw-app"
            mkdir -p "${OPENCLAW_PREFIX}"
            last_code=1
            i=1
            until [ "$i" -gt 6 ]; do
              if timeout 240 npm install --prefix "${OPENCLAW_PREFIX}" openclaw@latest --omit=optional --ignore-scripts --no-fund --no-audit --loglevel=error; then
                break
              fi
              last_code=$?
              if [ "$i" -eq 6 ]; then
                echo "npm-install-failed code=${last_code}"
                ls -lah /tmp/.npm/_logs || true
                for f in /tmp/.npm/_logs/*-debug-0.log; do
                  [ -f "$f" ] || continue
                  echo "==== npm log: $f (tail) ===="
                  tail -n 120 "$f" || true
                done
                exit "${last_code}"
              fi
              sleep_time=$((i * 10))
              echo "npm-install-retry attempt=${i} sleep=${sleep_time}s"
              sleep "${sleep_time}"
              i=$((i + 1))
            done

    - name: verify_openclaw
      depends_on: [install_openclaw]
      run:
        program: sh
        args:
          - -lc
          - |
            set -eux
            test -x /tmp/openclaw-app/node_modules/.bin/openclaw
            /tmp/openclaw-app/node_modules/.bin/openclaw --version
            timeout 20 /tmp/openclaw-app/node_modules/.bin/openclaw --help >/dev/null
            echo "openclaw smoke ok"

  output_step: verify_openclaw
